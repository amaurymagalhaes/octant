variables:
  KANIKO_VERSION: v1.9.2
  FF_USE_FASTZIP: "true"
  CACHE_COMPRESSION_LEVEL: "fast"
  TRANSFER_METER_FREQUENCY: "2s"
  MASTER_BRANCH: "master"
  IMAGE_TAG: $CI_COMMIT_SHA
  EPOCH_0_END: 1690848000
  EPOCH_1_END: 1698796800

stages:
  - build
  - lint_and_typecheck
  - test
  - publish
  - contracts
  - e2e
  - deploy
  - cleanup

default:
  tags:
    - metal
  interruptible: true

.images:
  python:
    name: acidrain/python-poetry:3.11-1.5.1
    pull_policy: if-not-present
  node:
    name: registry.gitlab.com/wildland/devops/container-builder/octant/node-extended:latest
    pull_policy: if-not-present
  kaniko:
    name: gcr.io/kaniko-project/executor:$KANIKO_VERSION-debug
    pull_policy: if-not-present
    entrypoint: [""]
  git_improved:
    name: mikecode/git-gettext:ubuntu
    pull_policy: if-not-present
  synpress:
    name: registry.gitlab.com/wildland/devops/container-builder/octant/synpress-arch:179ba913
    pull_policy: if-not-present
  alpine_git:
    name: alpine/git
    pull_policy: if-not-present
    entrypoint: [""]

.rules:
  on_mr:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  on_push_to_default_branch:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  on_push_to_default_branch_manual:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
      allow_failure: true
  on_push_to_master_branch:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $MASTER_BRANCH
  on_push_to_master_branch_manual:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $MASTER_BRANCH
      when: manual
      allow_failure: true
  on_mr_manual:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true
  on_version_tag:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'


.scripts:
  yarn_install:
    - yarn install --cache-folder .yarn --non-interactive --frozen-lockfile
  poetry_install:
    - poetry config virtualenvs.in-project true
    - poetry install

Build backend:
  stage: build
  image: !reference [.images, python ]
  rules:
    - !reference [.rules, on_mr ]
    - !reference [.rules, on_push_to_default_branch ]
    - !reference [.rules, on_push_to_master_branch ]
  script:
    - ci/build_backend.sh
  cache:
    - key: $CI_COMMIT_REF_SLUG-poetry-backend
      policy: push
      paths:
        - backend/.venv

Build contracts:
  stage: build
  image: !reference [.images, node ]
  rules:
    - !reference [.rules, on_mr ]
    - !reference [.rules, on_push_to_default_branch ]
    - !reference [.rules, on_push_to_master_branch ]
  script:
    - ci/build_contracts_v1.sh
  cache:
    - key: $CI_COMMIT_REF_SLUG-yarn-root
      paths:
        - node_modules
        - .yarn
    - key: $CI_COMMIT_REF_SLUG-yarn-contracts
      paths:
        - contracts-v1/.yarn
        - contracts-v1/node_modules
  artifacts:
    name: contracts
    paths:
      - contracts-v1/artifacts
      - contracts-v1/typechain
    expire_in: 3 days

Build services:
  stage: build
  image: !reference [.images, node ]
  parallel:
    matrix:
      - SERVICE:
          - client
          - coin-prices-server
          - subgraph
  rules:
    - !reference [.rules, on_mr ]
    - !reference [.rules, on_push_to_default_branch ]
    - !reference [.rules, on_push_to_master_branch ]
  dependencies:
    - Build contracts
  needs:
    - Build contracts
  script:
    - ci/build_$SERVICE.sh
  cache:
    - key: $CI_COMMIT_REF_SLUG-yarn-root
      paths:
        - node_modules
        - .yarn
      policy: pull
    - key: $CI_COMMIT_REF_SLUG-yarn-$SERVICE
      paths:
        - $SERVICE/.yarn
        - $SERVICE/node-modules

Lint and typecheck yarn:
  stage: lint_and_typecheck
  image: !reference [.images, node ]
  parallel:
    matrix:
      - SERVICE:
          - contracts-v1
          - client
          - coin-prices-server
          - subgraph
  rules:
    - !reference [.rules, on_mr ]
    - !reference [.rules, on_push_to_default_branch ]
    - !reference [.rules, on_push_to_master_branch ]
  script:
    - cd $SERVICE
    - !reference [ .scripts, yarn_install ]
    - yarn eslint
    - yarn type-check
  cache:
    - key: $CI_COMMIT_REF_SLUG-yarn-root
      paths:
        - node_modules
        - .yarn
      policy: pull
    - key: $CI_COMMIT_REF_SLUG-yarn-$SERVICE
      paths:
        - $SERVICE/.yarn
        - $SERVICE/node-modules
      policy: pull

Lint and typecheck poetry:
  stage: lint_and_typecheck
  image: !reference [.images, python ]
  rules:
    - !reference [.rules, on_mr ]
    - !reference [.rules, on_push_to_default_branch ]
    - !reference [.rules, on_push_to_master_branch ]
  script:
    - cd backend
    - !reference [ .scripts, poetry_install ]
    - poetry run black --check --extend-exclude .venv .
    - poetry run flake8
  cache:
    - key: $CI_COMMIT_REF_SLUG-poetry-backend-lint
      paths:
        - backend/.venv
      policy: pull

Backend tests:
  stage: test
  image: !reference [.images, python ]
  rules:
    - !reference [.rules, on_mr ]
    - !reference [.rules, on_push_to_default_branch ]
    - !reference [.rules, on_push_to_master_branch ]
  dependencies:
    - Build backend
  script:
    - cd backend
    - !reference [ .scripts, poetry_install ]
    - poetry run pytest
  cache:
    - key: $CI_COMMIT_REF_SLUG-poetry-backend
      policy: pull
      paths:
        - backend/.venv

Unit tests:
  stage: test
  image: !reference [.images, node ]
  parallel:
    matrix:
      - SERVICE:
          - contracts-v1
          - client
          - coin-prices-server
          - subgraph
  rules:
    - !reference [.rules, on_mr ]
    - !reference [.rules, on_push_to_default_branch ]
    - !reference [.rules, on_push_to_master_branch ]
  script:
    - cd $SERVICE
    - !reference [ .scripts, yarn_install ]
    - yarn test
  cache:
    - key: $CI_COMMIT_REF_SLUG-yarn-root
      paths:
        - node_modules
        - .yarn
      policy: pull
    - key: $CI_COMMIT_REF_SLUG-yarn-$SERVICE
      paths:
        - $SERVICE/.yarn
        - $SERVICE/node-modules
      policy: pull

Documentation:
  stage: test
  image: !reference [.images, node ]
  parallel:
    matrix:
      - SERVICE:
         - contracts-v1
  rules:
    - !reference [.rules, on_mr ]
    - !reference [.rules, on_push_to_default_branch ]
    - !reference [.rules, on_push_to_master_branch ]
  script:
    - cd $SERVICE
    - !reference [ .scripts, yarn_install ]
    - yarn docs
  cache:
    - key: $CI_COMMIT_REF_SLUG-yarn-root
      paths:
        - node_modules
        - .yarn
      policy: pull
    - key: $CI_COMMIT_REF_SLUG-yarn-$SERVICE
      paths:
        - $SERVICE/.yarn
        - $SERVICE/node-modules
      policy: pull
  artifacts:
    name: $SERVICE_docs
    paths:
      - $SERVICE/.docs/
    expire_in: 3 days

Build images:
  stage: publish
  image: !reference [.images, kaniko ]
  rules:
    - !reference [.rules, on_mr ]
    - !reference [.rules, on_push_to_default_branch ]
    - !reference [.rules, on_push_to_master_branch ]
    - !reference [.rules, on_version_tag]
  parallel:
    matrix:
      - SERVICE:
          - contracts-v1
          - coin-prices-server
          - client
          - subgraph
          - backend
  variables:
    IMAGE_NAME: $SERVICE
    GOOGLE_APPLICATION_CREDENTIALS: /kaniko/config.json
  script:
    - echo $KANIKO_CACHE_CONFIG > /kaniko/.docker/config.json
    - echo "$GCP_REGISTRY_PUSHER_SERVICE_ACCOUNT" | base64 -d > /kaniko/config.json
    - chmod 400 /kaniko/config.json
    - /kaniko/executor
      --context "$CI_PROJECT_DIR/$SERVICE"
      --dockerfile "$CI_PROJECT_DIR/ci/Dockerfile.$SERVICE"
      --destination "${GCP_DOCKER_IMAGE_REGISTRY}/$IMAGE_NAME:$IMAGE_TAG"
      --build-arg VERSION_TAG=$CI_COMMIT_SHORT_SHA
      --cache=true
      --cache-repo=$KANIKO_CACHE_REPO
      --insecure-pull

Deploy contracts:
  stage: contracts
  image:
    name: ${GCP_DOCKER_IMAGE_REGISTRY}/contracts-v1:${IMAGE_TAG}
    entrypoint: [""]
  rules:
    - !reference [.rules, on_mr ]
    - !reference [.rules, on_push_to_default_branch ]
    - !reference [.rules, on_push_to_master_branch ]
  variables:
    NETWORK: sepolia
  artifacts:
    reports:
      dotenv: build.env
  tags:
    - contracts
    - octant
  script:
    - /app/entrypoint.sh $NETWORK $CI_PROJECT_DIR/build.env

Cypress E2E Tests Epoch 1:
  stage: e2e
  image: !reference [.images, synpress ]
  dependencies:
    - Deploy contracts
  rules:
    - !reference [.rules, on_mr]
    - !reference [.rules, on_push_to_default_branch ]
    - !reference [.rules, on_push_to_master_branch ]
  variables:
    NETWORK_NAME: sepolia
    PRIVATE_KEY: $GOERLI_PRIVATE_KEY
    CYPRESS_DOCKER_RUN: "true"
    CI: "true"
    METAMASK_VERSION: "10.25.0"
    SECRET_WORDS: test test test test test test test test test test test junk
    EPOCH_0_END: 0
    EPOCH_1_END: 1698796800
  artifacts:
    when: on_failure
    name: cypress
    paths:
      - client/cypress/videos
      - client/cypress/screenshots
    expire_in: 3 days
  cache:
    - key: $CI_COMMIT_REF_SLUG-yarn-client
      policy: pull
      paths:
        - client/.yarn
        - client/node-modules
    - key: $CI_COMMIT_REF_SLUG-yarn-root
      policy: pull
      paths:
        - node_modules
        - .yarn
  script:
    - set -e
    # Setup NVM to use Node version 16
    - source /usr/share/nvm/init-nvm.sh
    - nvm install 16
    - npm i -g yarn
    - source $CI_PROJECT_DIR/ci/argocd/resolve_env.sh e2e
    - bash $CI_PROJECT_DIR/ci/argocd/application.sh create
    - cd client
    - yarn install --cache-folder .yarn --frozen-lockfile --prefer-offline --no-audit
    - export OCTANT_BASE_URL=https://$(bash $CI_PROJECT_DIR/ci/argocd/get_web_client_url.sh)
    - set +e
    - yarn synpress:run || CY_EXIT_CODE=$?
    - if [[ "$CY_EXIT_CODE" == "0" ]]; then rm -r $CI_PROJECT_DIR/client/cypress/videos $CI_PROJECT_DIR/client/cypress/screenshots; fi
    - set -e
    - bash $CI_PROJECT_DIR/ci/argocd/application.sh delete
    - exit $CY_EXIT_CODE

Force destroy E2E env:
  stage: e2e
  image: !reference [.images, git_improved ]
  rules:
    - !reference [.rules, on_mr_manual]
    - !reference [.rules, on_push_to_default_branch_manual]
    - !reference [.rules, on_push_to_master_branch_manual ]
  allow_failure: true
  script:
    - source $CI_PROJECT_DIR/ci/argocd/resolve_env.sh e2e
    - bash $CI_PROJECT_DIR/ci/argocd/application.sh destroy

.deploy:
  stage: deploy
  image: !reference [.images, git_improved ]
  dependencies:
    - Deploy contracts
  script:
    - source $CI_PROJECT_DIR/ci/argocd/resolve_env.sh $ENV_TYPE
    - bash $CI_PROJECT_DIR/ci/argocd/application.sh create
  environment:
    action: start

.destroy:
  stage: cleanup
  image: !reference [.images, git_improved ]
  script:
    - source $CI_PROJECT_DIR/ci/argocd/resolve_env.sh $ENV_TYPE
    - bash $CI_PROJECT_DIR/ci/argocd/application.sh destroy
  environment:
    action: stop

Deploy MR App:
  extends:
    - .deploy
  variables:
    ENV_TYPE: "mr"
    EPOCH_0_END: 0
    EPOCH_1_END: 1698796800
  rules:
    - !reference [.rules, on_mr_manual]
  environment:
    name: mr/$CI_MERGE_REQUEST_IID
    deployment_tier: development
    on_stop: Destroy MR App

Deploy UAT App:
  extends:
    - .deploy
  variables:
    ENV_TYPE: "uat"
  rules:
    - !reference [.rules, on_mr_manual]
    - !reference [.rules, on_push_to_default_branch_manual]
  environment:
    name: persistent/uat
    url: https://uat-client.octant.wildland.dev
    deployment_tier: testing
    on_stop: Destroy UAT App

Destroy MR App:
  extends:
    - .destroy
  variables:
    ENV_TYPE: "mr"
  rules:
    - !reference [.rules, on_mr_manual]
  needs: []
  environment:
    name: mr/$CI_MERGE_REQUEST_IID
    deployment_tier: development

Destroy UAT App:
  extends:
    - .destroy
  variables:
    ENV_TYPE: "uat"
  rules:
    - !reference [.rules, on_mr_manual]
    - !reference [ .rules, on_push_to_default_branch_manual ]
  needs: []
  environment:
    name: persistent/uat
    deployment_tier: testing

Deploy Release Candidate app:
  stage: deploy
  image: !reference [.images, alpine_git]
  rules:
    - !reference [.rules, on_push_to_master_branch_manual]
  resource_group: production
  variables:
    ARGO_REPOSITORY: "https://wildland-bot:${HOUSEKEEPER_CI_TOKEN}@gitlab.com/wildland/devops/iac/k8s/wildland-k8s-devops.git"
    ARGO_REPOSITORY_BRANCH: "gitlab/octant-testing"
  script: |
    set -ex
    apk add gpg-agent yq
    gpg --import <(echo $HOUSEKEEPER_GPG_KEY | base64 -d)
    git config --global user.name "Wildland Housekeeper"
    git config --global user.email "$HOUSEKEEPER_EMAIL"
    git config --global user.signingkey $HOUSEKEEPER_GPG_KEY_ID

    GIT_DIR=`mktemp -d`
    git clone -b $ARGO_REPOSITORY_BRANCH $ARGO_REPOSITORY $GIT_DIR

    cd $GIT_DIR

    cat mainnet/octant-image.values.yaml | yq -r ".[0].value.value = \"$IMAGE_TAG\"" | tee mainnet/octant-image.values.yaml
    cat testnet/octant-image.values.yaml | yq -r ".[0].value.value = \"$IMAGE_TAG\"" | tee testnet/octant-image.values.yaml

    git add mainnet/octant-image.values.yaml
    git add testnet/octant-image.values.yaml
    git commit -S -m "Changed octant image tag to $IMAGE_TAG at $(date +%Y-%m-%d)" || true

    git push
  environment:
    name: persistent/prod
    url: https://client.testnet.octant.wildland.dev

Deploy production app:
  stage: deploy
  rules:
    - !reference [.rules, on_version_tag]
  variables:
    DEV_IMAGE_TAG: $CI_COMMIT_SHA
    PROD_IMAGE_TAG: $CI_COMMIT_TAG
  trigger:
    project: wildland/devops/pipelines/octant-production
    branch: master
